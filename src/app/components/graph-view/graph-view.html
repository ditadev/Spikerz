<div class="relative w-full graph-container">
  <div class="w-full h-full overflow-x-auto overflow-y-hidden lg:overflow-visible">
    <div class="min-w-[695px] lg:min-w-0 lg:w-full lg:h-full">
      <svg
        #svgCanvas
        class="w-full h-full"
        viewBox="0 0 727 307"
        preserveAspectRatio="xMidYMid meet"
        (click)="onCanvasClick($event)"
        (keydown.enter)="onCanvasClick($event)"
        (keydown.space)="onCanvasClick($event)"
        tabindex="0"
        role="img"
        aria-label="Network graph visualization"
      >
        <defs>
          <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#94A3B8" />
          </marker>

          <marker
            id="arrowhead-branch"
            markerWidth="10"
            markerHeight="10"
            refX="9"
            refY="5"
            orient="auto"
          >
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#858D9D" />
          </marker>
        </defs>

        <g class="edges">
          @for (edge of edges(); track edge.source + edge.target) {
            @if (edge.source === '1' && edge.target === '2') {
              <image
                [attr.href]="'assets/icons/arrow.svg'"
                [attr.x]="getNodePosition(edge.source).x + 32"
                [attr.y]="getNodePosition(edge.source).y - 1.5"
                [attr.width]="getNodePosition(edge.target).x - getNodePosition(edge.source).x - 64"
                height="3"
                preserveAspectRatio="none"
              />
            } @else if (edge.source === '2' && edge.target === '3') {
              <image
                [attr.href]="'assets/icons/arrow.svg'"
                [attr.x]="getNodePosition(edge.source).x + 32"
                [attr.y]="getNodePosition(edge.source).y - 1.5"
                [attr.width]="getNodePosition(edge.target).x - getNodePosition(edge.source).x - 64"
                height="3"
                preserveAspectRatio="none"
              />
            } @else if (edge.source === '3' && edge.target === '4') {
              <path
                [attr.d]="getBranchPath(edge, 'up')"
                stroke="#858D9D"
                stroke-width="0.75"
                fill="none"
                marker-end="url(#arrowhead-branch)"
                stroke-linejoin="round"
              />
            } @else if (edge.source === '3' && edge.target === '5') {
              <path
                [attr.d]="getBranchPath(edge, 'down')"
                stroke="#858D9D"
                stroke-width="0.75"
                fill="none"
                marker-end="url(#arrowhead-branch)"
                stroke-linejoin="round"
              />
            }
          }
        </g>

        <g class="nodes">
          @for (node of nodes(); track node.id) {
            <g
              class="node-group cursor-pointer"
              [attr.transform]="'translate(' + node.x + ',' + node.y + ')'"
              (click)="onNodeClick(node, $event)"
              (mouseenter)="onNodeHover(node, $event)"
              (mouseleave)="onNodeLeave()"
              (touchend)="onNodeTouch(node, $event)"
            >
              <circle r="40" fill="transparent" class="pointer-events-auto" />

              @if (node.id === '1') {
                <circle
                  r="24"
                  fill="#FEE2E2"
                  class="node-circle transition-all duration-200 pointer-events-none"
                />
              } @else {
                <circle
                  r="24"
                  fill="#DBEAFE"
                  class="node-circle transition-all duration-200 pointer-events-none"
                />
              }

              <g>
                @if (node.id === '1') {
                  <image
                    [attr.href]="'assets/icons/node1.svg'"
                    x="-16"
                    y="-16"
                    width="32"
                    height="32"
                    class="pointer-events-none"
                  />
                } @else {
                  <image
                    [attr.href]="'assets/icons/server.svg'"
                    x="-26.5"
                    y="-26.5"
                    width="53"
                    height="53"
                    class="pointer-events-none"
                  />
                }
              </g>

              @if (node.badge) {
                @if (node.id === '1') {
                  <image
                    [attr.href]="'assets/icons/node1-notification.svg'"
                    x="6"
                    y="-30"
                    width="24"
                    height="24"
                    class="pointer-events-none"
                  />
                } @else {
                  <circle
                    cx="18"
                    cy="-18"
                    r="12"
                    fill="#EF4444"
                    class="badge-circle pointer-events-none"
                  />
                  <svg
                    x="10"
                    y="-26"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="white"
                    stroke-width="2"
                    class="pointer-events-none"
                  >
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                    <line x1="9" y1="9" x2="15" y2="15" />
                    <line x1="15" y1="9" x2="9" y2="15" />
                  </svg>
                }
              }

              <text
                y="45"
                text-anchor="middle"
                class="fill-gray-700 pointer-events-none select-none"
                style="
                  font-family: 'Public Sans', sans-serif;
                  font-size: 13px;
                  line-height: 13.5px;
                  font-weight: 600;
                  letter-spacing: 0px;
                  text-transform: capitalize;
                "
              >
                {{ node.label }}
              </text>

              @if (node.sublabel) {
                <text
                  y="58"
                  text-anchor="middle"
                  class="fill-gray-500 pointer-events-none select-none"
                  style="
                    font-family: 'Public Sans', sans-serif;
                    font-size: 9.45px;
                    line-height: 10.13px;
                    font-weight: 500;
                    letter-spacing: 0px;
                    text-align: center;
                  "
                >
                  {{ node.sublabel }}
                </text>
              }
            </g>
          }
        </g>
      </svg>
    </div>
  </div>

  @if (hoveredNode()) {
    <app-node-tooltip [data]="hoveredNode()!.data" [position]="hoveredNode()!.position">
    </app-node-tooltip>
  }

  <div class="absolute bottom-16 left-0 right-0 px-4 md:px-6">
    <div class="border-t border-gray-200"></div>
  </div>

  <div class="absolute bottom-0 left-0 right-0 px-4 md:px-6 py-4">
    <div class="flex items-center gap-3 md:gap-4 flex-wrap">
      <div class="flex items-center gap-2">
        <div
          class="w-5 h-5 md:w-6 md:h-6 rounded-full flex items-center justify-center flex-shrink-0"
          style="background: var(--color-critical, #e5372b)"
        >
          <svg
            class="w-3 h-3 md:w-4 md:h-4 text-white"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            <line x1="9" y1="9" x2="15" y2="15" />
            <line x1="15" y1="9" x2="9" y2="15" />
          </svg>
        </div>
        <span
          class="whitespace-nowrap"
          style="
            font-family: 'Public Sans', sans-serif;
            font-size: 15px;
            line-height: 38px;
            font-weight: 700;
            letter-spacing: 0px;
            color: var(--color-critical, #e5372b);
          "
          >Lorem</span
        >
      </div>
      <div class="flex items-center gap-2">
        <div
          class="w-5 h-5 md:w-6 md:h-6 rounded-full flex items-center justify-center flex-shrink-0"
          style="background: var(--color-warning, #ff9500)"
        >
          <svg
            class="w-3 h-3 md:w-4 md:h-4 text-white"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            <line x1="9" y1="9" x2="15" y2="15" />
            <line x1="15" y1="9" x2="9" y2="15" />
          </svg>
        </div>
        <span
          class="whitespace-nowrap"
          style="
            font-family: 'Public Sans', sans-serif;
            font-size: 15px;
            line-height: 38px;
            font-weight: 700;
            letter-spacing: 0px;
            color: var(--color-warning, #ff9500);
          "
          >Lorem</span
        >
      </div>
      <div class="flex items-center gap-2">
        <div
          class="w-5 h-5 md:w-6 md:h-6 rounded-full flex items-center justify-center flex-shrink-0"
          style="background: var(--color-success, #02983e)"
        >
          <svg
            class="w-3 h-3 md:w-4 md:h-4 text-white"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            <polyline points="9 11 12 14 15 10" />
          </svg>
        </div>
        <span
          class="whitespace-nowrap"
          style="
            font-family: 'Public Sans', sans-serif;
            font-size: 15px;
            line-height: 38px;
            font-weight: 700;
            letter-spacing: 0px;
            color: var(--color-success, #02983e);
          "
          >Lorem</span
        >
      </div>
    </div>
  </div>
</div>
