<div class="relative w-full graph-container">
  <div class="w-full h-full overflow-x-auto overflow-y-hidden lg:overflow-visible px-4 md:px-6">
    <div class="min-w-[727px] lg:min-w-0 lg:w-full lg:h-full">
      <svg 
        #svgCanvas
        class="w-full"
        style="height: calc(100% - 80px);"
        viewBox="0 0 727 307"
        preserveAspectRatio="xMidYMid meet"
        (click)="onCanvasClick($event)">
        
        <!-- Define arrow markers -->
        <defs>
          <marker
            id="arrowhead"
            markerWidth="10"
            markerHeight="10"
            refX="9"
            refY="5"
            orient="auto">
            <path
              d="M 0 0 L 10 5 L 0 10 z"
              fill="#94A3B8"
            />
          </marker>
          
          <marker
            id="arrowhead-branch"
            markerWidth="10"
            markerHeight="10"
            refX="9"
            refY="5"
            orient="auto">
            <path
              d="M 0 0 L 10 5 L 0 10 z"
              fill="#858D9D"
            />
          </marker>
        </defs>

        <!-- Render edges -->
        <g class="edges">
          @for (edge of edges(); track edge.source + edge.target) {
            @if (edge.source === '1' && edge.target === '2') {
              <!-- Arrow from node 1 to node 2 using SVG image -->
              <image 
                [attr.href]="'assets/icons/arrow.svg'"
                [attr.x]="getNodePosition(edge.source).x + 32"
                [attr.y]="getNodePosition(edge.source).y - 1.5"
                [attr.width]="getNodePosition(edge.target).x - getNodePosition(edge.source).x - 64"
                height="3"
                preserveAspectRatio="none"
              />
            } @else if (edge.source === '2' && edge.target === '3') {
              <!-- Arrow from node 2 to node 3 using SVG image -->
              <image 
                [attr.href]="'assets/icons/arrow.svg'"
                [attr.x]="getNodePosition(edge.source).x + 32"
                [attr.y]="getNodePosition(edge.source).y - 1.5"
                [attr.width]="getNodePosition(edge.target).x - getNodePosition(edge.source).x - 64"
                height="3"
                preserveAspectRatio="none"
              />
            } @else if (edge.source === '3' && edge.target === '4') {
              <!-- Upper branch: node 3 to node 4 -->
              <path
                [attr.d]="getBranchPath(edge, 'up')"
                stroke="#858D9D"
                stroke-width="0.75"
                fill="none"
                marker-end="url(#arrowhead-branch)"
                stroke-linejoin="round"
              />
            } @else if (edge.source === '3' && edge.target === '5') {
              <!-- Lower branch: node 3 to node 5 -->
              <path
                [attr.d]="getBranchPath(edge, 'down')"
                stroke="#858D9D"
                stroke-width="0.75"
                fill="none"
                marker-end="url(#arrowhead-branch)"
                stroke-linejoin="round"
              />
            }
          }
        </g>

        <!-- Render nodes -->
        <g class="nodes">
          @for (node of nodes(); track node.id) {
            <g 
              class="node-group cursor-pointer"
              [attr.transform]="'translate(' + node.x + ',' + node.y + ')'"
              (click)="onNodeClick(node, $event)"
              (mouseenter)="onNodeHover(node, $event)"
              (mouseleave)="onNodeLeave()">
              
              <!-- Node circle -->
              @if (node.id === '1') {
                <circle
                  r="24"
                  fill="#FEE2E2"
                  class="node-circle transition-all duration-200"
                />
              } @else {
                <!-- Light blue circle for server nodes -->
                <circle
                  r="24"
                  fill="#DBEAFE"
                  class="node-circle transition-all duration-200"
                />
              }
              
              <!-- Node icon -->
              <g>
                @if (node.id === '1') {
                  <!-- Node 1 icon -->
                  <image 
                    [attr.href]="'assets/icons/node1.svg'" 
                    x="-16" 
                    y="-16" 
                    width="32" 
                    height="32"
                    class="pointer-events-none"
                  />
                } @else {
                  <!-- Other nodes icon -->
                  <image 
                    [attr.href]="'assets/icons/other-nodes.svg'" 
                    x="-16" 
                    y="-16" 
                    width="32" 
                    height="32"
                    class="pointer-events-none"
                  />
                }
              </g>
              
              <!-- Badge for critical items -->
              @if (node.badge) {
                @if (node.id === '1') {
                  <!-- Node 1 notification badge -->
                  <image 
                    [attr.href]="'assets/icons/node1-notification.svg'" 
                    x="6" 
                    y="-30" 
                    width="24" 
                    height="24"
                    class="pointer-events-none"
                  />
                } @else {
                  <!-- Red shield with X for other nodes -->
                  <circle
                    cx="18"
                    cy="-18"
                    r="12"
                    fill="#EF4444"
                    class="badge-circle"
                  />
                  <!-- Shield with X icon -->
                  <svg x="10" y="-26" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" class="pointer-events-none">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                  </svg>
                }
              }
              
              <!-- Node label -->
              <text
                y="45"
                text-anchor="middle"
                class="fill-gray-700 font-medium pointer-events-none select-none"
                style="font-size: 13px;"
              >
                {{ node.label }}
              </text>
              
              <!-- Node sublabel (IP address) -->
              @if (node.sublabel) {
                <text
                  y="60"
                  text-anchor="middle"
                  class="fill-gray-500 pointer-events-none select-none"
                  style="font-size: 11px;"
                >
                  {{ node.sublabel }}
                </text>
              }
            </g>
          }
        </g>
      </svg>
    </div>
  </div>

  <!-- Tooltip -->
  @if (hoveredNode()) {
    <app-node-tooltip 
      [data]="hoveredNode()!.data"
      [position]="hoveredNode()!.position">
    </app-node-tooltip>
  }

  <!-- Divider -->
  <div class="absolute bottom-16 left-0 right-0 px-4 md:px-6">
    <div class="border-t border-gray-200"></div>
  </div>

  <!-- Legend at bottom -->
  <div class="absolute bottom-0 left-0 right-0 px-4 md:px-6 py-4">
    <div class="flex items-center gap-3 md:gap-4 flex-wrap">
      <div class="flex items-center gap-2">
        <div class="w-5 h-5 md:w-6 md:h-6 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-3 h-3 md:w-4 md:h-4 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
          </svg>
        </div>
        <span class="text-xs font-medium text-red-500 whitespace-nowrap">Lorem</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-5 h-5 md:w-6 md:h-6 bg-yellow-500 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-3 h-3 md:w-4 md:h-4 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
          </svg>
        </div>
        <span class="text-xs font-medium text-yellow-500 whitespace-nowrap">Lorem</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-5 h-5 md:w-6 md:h-6 bg-emerald-500 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-3 h-3 md:w-4 md:h-4 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
          </svg>
        </div>
        <span class="text-xs font-medium text-emerald-500 whitespace-nowrap">Lorem</span>
      </div>
    </div>
  </div>
</div>